{{- if .Values.database.deploy }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cost-onprem.fullname" . }}-db-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cost-onprem.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
  annotations:
    # Create database init scripts before database StatefulSet starts (pre-install hook)
    # No delete policy - ConfigMap persists and remains managed by Helm
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-15"
data:
  # PostgreSQL initialization script for all on-prem databases
  # This script runs automatically on first database initialization
  # Uses PostgreSQL's /docker-entrypoint-initdb.d/ mechanism
  #
  # Creates databases: costonprem_ros, costonprem_kruize, costonprem_koku
  # Shell script wrapper that passes password environment variables to SQL commands
  init-databases.sh: |
    #!/bin/bash
    set -e

    echo "Initializing databases with user-specific credentials..."

    # Create users with passwords from environment variables
    # Using SQL with string interpolation (safe because we control the environment)
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname postgres <<EOF
    -- ========================================
    -- Create Dedicated Database Users
    -- ========================================

    -- ROS User
    DO \$\$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$ROS_USER') THEN
        EXECUTE 'CREATE USER $ROS_USER WITH PASSWORD ' || quote_literal('$ROS_PASSWORD');
      END IF;
    END
    \$\$;

    -- Kruize User
    DO \$\$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$KRUIZE_USER') THEN
        EXECUTE 'CREATE USER $KRUIZE_USER WITH PASSWORD ' || quote_literal('$KRUIZE_PASSWORD');
      END IF;
    END
    \$\$;

    -- Koku User
    DO \$\$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$KOKU_USER') THEN
        EXECUTE 'CREATE USER $KOKU_USER WITH PASSWORD ' || quote_literal('$KOKU_PASSWORD');
      END IF;
    END
    \$\$;

    -- ========================================
    -- Create Databases
    -- ========================================

    -- ROS Database
    SELECT 'CREATE DATABASE {{ .Values.database.ros.name }}'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .Values.database.ros.name }}')
    \gexec

    -- Kruize Database
    SELECT 'CREATE DATABASE {{ .Values.database.kruize.name }}'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .Values.database.kruize.name }}')
    \gexec

    -- Koku Database
    SELECT 'CREATE DATABASE {{ .Values.database.koku.name }}'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .Values.database.koku.name }}')
    \gexec

    -- ========================================
    -- Grant Database Ownership and Privileges
    -- ========================================

    -- ROS Database - owned by $ROS_USER
    GRANT ALL PRIVILEGES ON DATABASE {{ .Values.database.ros.name }} TO $ROS_USER;
    ALTER DATABASE {{ .Values.database.ros.name }} OWNER TO $ROS_USER;

    -- Kruize Database - owned by $KRUIZE_USER
    GRANT ALL PRIVILEGES ON DATABASE {{ .Values.database.kruize.name }} TO $KRUIZE_USER;
    ALTER DATABASE {{ .Values.database.kruize.name }} OWNER TO $KRUIZE_USER;

    -- Koku Database - owned by $KOKU_USER
    GRANT ALL PRIVILEGES ON DATABASE {{ .Values.database.koku.name }} TO $KOKU_USER;
    ALTER DATABASE {{ .Values.database.koku.name }} OWNER TO $KOKU_USER;

    -- Enable pg_stat_statements extension on koku database
    \c {{ .Values.database.koku.name }}
    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
{{- end }}
